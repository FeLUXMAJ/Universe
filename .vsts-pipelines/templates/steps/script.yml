# File: templates/steps/script.yml

parameters:
  agentOs: 'Windows'
  beforeBuild: []
  buildScript: ''
  buildArgs: ''
  afterBuild: []
  hasTests: false

steps:
  - checkout: self
    clean: true
  - ${{ parameters.beforeBuild }}
  - ${{ if eq(parameters.agentOs, 'Windows') }}:
    - task: Powershell@1
      displayName: ${{ parameters.buildScript }}
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_HOME: '$(Build.SourcesDirectory)/.dotnet'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      inputs:
        scriptType: filePath
        scriptName: ${{ parameters.buildScript }}
        arugments: ${{ parameters.buildArgs }}
  - ${{ if ne(parameters.agentOs, 'Windows') }}:
    - task: Bash@3
      displayName: ${{ parameters.buildScript }}
      env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
        DOTNET_HOME: '$(Build.SourcesDirectory)/.dotnet'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      inputs:
        scriptType: filePath
        filePath: ${{ parameters.buildScript }}
        arugments: ${{ parameters.buildArgs }}
  - ${{ if eq(parameters.hasTests, true) }}:
    - task: PublishTestResults@2
      displayName: Publish test results
      condition: always()
      inputs:
        testRunner: vstest
        testResultsFiles: 'artifacts/logs/**/*.trx'
  - ${{ parameters.afterBuild }}



    # ${{ if and(eq(parameters.buildScript, ''), eq(parameters.agentOs, 'Windows')) }}:
    #   BuildScript: './build.cmd'
    # ${{ if and(eq(parameters.buildScript, ''), ne(parameters.agentOs, 'Windows')) }}:
    #   BuildScript: './build.ps1'
    # ${{ if ne(parameters.buildScript, '') }}:
    #   BuildScript: ${{ parameters.buildScript }}
